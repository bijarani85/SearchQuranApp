<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>البحث في القرآن</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  @font-face {
    font-family: 'AlQalam';
    src: url('alqalam.ttf') format('truetype');
  }
  :root { --base-font-size: clamp(1.6rem, 5.0vw, 1.9rem); }
  body {
    font-family: 'AlQalam', sans-serif;
    padding: 0.5rem;
    background: #fffdd2;   
    color: #111;
    font-size: var(--base-font-size);
    line-height: 1.4;
    direction: rtl;
    unicode-bidi: plaintext;
  }
  h2 { font-size: var(--base-font-size); margin: 0.3rem 0 0.6rem 0; text-align: center; }
  input {
    width: 100%; 
    font-size: var(--base-font-size);
    font-family: 'AlQalam', sans-serif;
    border: 1px solid #ccc; 
    border-radius: 10px;
    box-sizing: border-box; 
    margin-bottom: 1rem;
    padding: 0 0.6rem;
    height: calc(1em + 0.8rem);
    text-align: right;
    background: #fffdd2;   
  }
  input[type="radio"] { transform: scale(1); width: auto; height: auto; background: #fffdd2; }
  ul { list-style: none; padding: 0; margin: 0.4rem 0; background: #fffdd2; }
  #suggestionList {
    display: flex; flex-wrap: wrap; gap: 0.6rem; padding: 0.5rem 0;
    overflow-y: auto; max-height: 8rem; background: #fffdd2;
  }
  #suggestionList li {
    display: inline-block; background: #e0f0ff;
    padding: 0.3rem 0.6rem; border-radius: 6px; border: 1px solid #ccc;
    font-size: var(--base-font-size); cursor: pointer; white-space: nowrap; color: #000;
  }
  #resultList { flex: 1; overflow-y: auto; background: #fffdd2; }
  #resultList li {
    padding: 0; margin: 0; border-bottom: 1px solid #ddd;
    cursor: pointer; font-size: var(--base-font-size); line-height: 1.4;
    background: #fffdd2;
  }
  #count { margin-top: 0.5rem; font-weight: bold; font-size: calc(var(--base-font-size) * 0.75); text-align: center; }
  label input[type="radio"] { transform: scale(1); }
  label { font-size: calc(var(--base-font-size) * 0.75); }
  mark { background: #e0f0ff; } 

  #searchContainer { position: relative; width: 100%; }

  /* --- POPUP --- */
  #popup {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #fffdd2;
    z-index: 10000;
    overflow: hidden;
    border-radius: 0;
  }

  /* bottom navy blue belt */
 #popupButtons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  padding: 0.3rem;
  background: #fffdd2;

  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);

  width: calc(100% - 2rem);
  max-width: 600px;
  box-sizing: border-box;
  z-index: 1000;
}

 #popupButtons button {
  flex: 0 0 auto;
  padding: 0.4rem 0.8rem;
  font-size: 1.4rem;
}

  #popupButtons button:hover { background: #e0f0ff; }

  #popupContent {
    overflow-y: auto;
    padding: 1rem;
    padding-top: 3.5rem;
    height: calc(100% - 4rem);
    -webkit-overflow-scrolling: touch;
  }
  .verseBlock {
    margin: 0.5rem 0.6rem;
    padding: 0;
    border-bottom: 1px dashed #aaa;
    border-radius: 8px;
    background: #ffffcf;
  }
  .verseRef {
    font-weight: bold;
    font-size: calc(var(--base-font-size) * 0.7);
    margin: 0.08rem 0;
    text-align: center;
    color: #333;
  }
  .verseText {
    font-size: var(--popup-font-size, 1.6rem);
    text-align: center;
    word-break: break-word;
    line-height: 1.8;
    margin: 0.2rem 0;
  }
  #listsContainer { display: flex; flex-direction: column; height: calc(100vh - 220px); background: #fffdd2; }
  #listsContainer.full-suggestions { height: calc(100vh - 180px); }
  #listsContainer.full-suggestions #suggestionList { flex: 1; max-height: none; overflow-y: auto; }
  #listsContainer.full-suggestions #resultList, #listsContainer.full-suggestions #count { display: none; }

  /* Settings Popup */
  #settingsPopup {
  display:none; 
  position: fixed;
  top: 10%;
  left: 9%;
  transform: translateX(-50%);
  background: #ffffcf;
  border: 2px solid #0074d9;
  border-radius: 10px;
  padding: 1rem;
  z-index: 20000;
  max-width: 90%;
  font-size: 1.4rem;
  text-align: right;
  margin-bottom: 6rem;  /* leaves space above the blue belt */
}
  #settingsPopup h3 { margin-top:0; }

  /* --- ARABIC KEYBOARD STYLES --- */
  #keyboardToggleBtn {
    background: #0074d9;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.4rem 1rem;
    cursor: pointer;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    font-family: sans-serif;
  }
  #virtualKeyboard {
    display: none;
    grid-template-columns: repeat(10, 1fr);
    gap: 4px;
    background: #e9e9c0;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    direction: rtl;
  }
  .key {
    background: #fff;
    border: 1px solid #bbb;
    border-radius: 4px;
    padding: 8px 0;
    text-align: center;
    cursor: pointer;
    font-family: 'AlQalam', sans-serif;
    font-size: 1.2rem;
    user-select: none;
    touch-action: manipulation;
  }
  .key:active { background: #d0d0d0; }
  .key.wide { grid-column: span 2; background: #dcdcb0; font-size: 1rem; }
</style>
</head>
<body>
<h2>البحث في القرآن</h2>

<div id="searchContainer">
  <div style="display: flex; justify-content: flex-end;">
    <button id="keyboardToggleBtn" onclick="toggleKeyboard()">Arabic keyboard ⌨️</button>
  </div>

  <div id="virtualKeyboard">
    <div class="key" onclick="typeChar('ض')">ض</div><div class="key" onclick="typeChar('ص')">ص</div>
    <div class="key" onclick="typeChar('ث')">ث</div><div class="key" onclick="typeChar('ق')">ق</div>
    <div class="key" onclick="typeChar('ف')">ف</div><div class="key" onclick="typeChar('غ')">غ</div>
    <div class="key" onclick="typeChar('ع')">ع</div><div class="key" onclick="typeChar('ه')">ه</div>
    <div class="key" onclick="typeChar('خ')">خ</div><div class="key" onclick="typeChar('ح')">ح</div>
    <div class="key" onclick="typeChar('ج')">ج</div><div class="key" onclick="typeChar('د')">د</div>
    <div class="key" onclick="typeChar('ش')">ش</div><div class="key" onclick="typeChar('س')">س</div>
    <div class="key" onclick="typeChar('ي')">ي</div><div class="key" onclick="typeChar('ب')">ب</div>
    <div class="key" onclick="typeChar('ل')">ل</div><div class="key" onclick="typeChar('ا')">ا</div>
    <div class="key" onclick="typeChar('ت')">ت</div><div class="key" onclick="typeChar('ن')">ن</div>
    <div class="key" onclick="typeChar('م')">م</div><div class="key" onclick="typeChar('ك')">ك</div>
    <div class="key" onclick="typeChar('ط')">ط</div><div class="key" onclick="typeChar('ئ')">ئ</div>
    <div class="key" onclick="typeChar('ء')">ء</div><div class="key" onclick="typeChar('ؤ')">ؤ</div>
    <div class="key" onclick="typeChar('ر')">ر</div><div class="key" onclick="typeChar('لا')">لا</div>
    <div class="key" onclick="typeChar('ى')">ى</div><div class="key" onclick="typeChar('ة')">ة</div>
    <div class="key" onclick="typeChar('و')">و</div><div class="key" onclick="typeChar('ز')">ز</div>
    <div class="key" onclick="typeChar('ظ')">ظ</div><div class="key" onclick="typeChar('ذ')">ذ</div>
    <div class="key" onclick="typeChar('آ')">آ</div><div class="key" onclick="typeChar('إ')">إ</div>
    <div class="key" onclick="typeChar('أ')">أ</div>
    <div class="key wide" onclick="typeChar(' ')">مسافة</div>
    <div class="key wide" onclick="backspaceKey()">حذف</div>
  </div>

  <input type="text" id="searchBox" placeholder="اكتب كلمة...">
  <div id="popup" style="display:none;">
    <div id="popupButtons">
      <button id="closeBtn" onclick="closePopup()">X</button>
      <button id="copyBtn" onclick="copyVisibleVerses()">Copy</button>
      <button id="increaseFontBtn" onclick="adjustFontSize(1)">+</button>
      <button id="decreaseFontBtn" onclick="adjustFontSize(-1)">−</button>
    </div>
    <div id="popupContent"></div>
  </div>
</div>

<div id="settingsPopup" onclick="event.stopPropagation()">
  <h3>إعدادات العرض</h3>
  <label><input type="checkbox" id="toggleArabic" checked> عرض النص العربي</label><br>
  <label><input type="checkbox" id="toggleWordByWord" checked> ترجمہ لفظ بہ لفظ</label><br>
  <label><input type="checkbox" id=\"toggleSimple\" checked> ترجمہ سادہ اردو</label><br>
  <label><input type="checkbox" id="toggleTafseer" checked> تفسیر اردو</label><br><br>
  <button onclick="closeSettingsPopup()">OK</button>
</div>

<div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; font-size: var(--base-font-size); background:#fffdd2;">
  <label><input type="radio" name="matchMode" value="exact">ابتداء لفظ</label>
  <label><input type="radio" name="matchMode" value="partial" checked="">وسط لفظ</label>
  <label><input type="radio" name="matchMode" value="suffix">آخر لفظ</label>
</div>

<div id="listsContainer">
  <ul id="suggestionList"></ul>
  <div id="count"></div>
  <ul id="resultList"></ul>
</div>

<script src="index.js"></script>
<script src="verses.js"></script>
<script src="wordByWord.js"></script>
<script src="simpleTranslation.js"></script>
<script src="tafseer.js"></script>

<script>
// --- VIRTUAL KEYBOARD LOGIC ---
function toggleKeyboard() {
  const kb = document.getElementById("virtualKeyboard");
  const isHidden = (kb.style.display === "none" || kb.style.display === "");
  
  if (isHidden) {
    kb.style.display = "grid";
    // Prevents system keyboard on Android/iOS when using virtual buttons
    searchBox.setAttribute("inputmode", "none"); 
  } else {
    kb.style.display = "none";
    searchBox.removeAttribute("inputmode");
  }
}

function typeChar(char) {
  const start = searchBox.selectionStart;
  const end = searchBox.selectionEnd;
  const text = searchBox.value;
  searchBox.value = text.slice(0, start) + char + text.slice(end);
  searchBox.selectionStart = searchBox.selectionEnd = start + char.length;
  searchBox.focus();
  // Trigger original search logic
  const event = new Event('input', { bubbles: true });
  searchBox.dispatchEvent(event);
}

function backspaceKey() {
  const start = searchBox.selectionStart;
  const end = searchBox.selectionEnd;
  const text = searchBox.value;
  if (start === end && start > 0) {
    searchBox.value = text.slice(0, start - 1) + text.slice(end);
    searchBox.selectionStart = searchBox.selectionEnd = start - 1;
  } else {
    searchBox.value = text.slice(0, start) + text.slice(end);
    searchBox.selectionStart = searchBox.selectionEnd = start;
  }
  searchBox.focus();
  const event = new Event('input', { bubbles: true });
  searchBox.dispatchEvent(event);
}

// settings popup handlers
function openSettingsPopup(){ document.getElementById("settingsPopup").style.display="block"; }
function closeSettingsPopup(){
  document.getElementById("settingsPopup").style.display="none";
  localStorage.setItem("showArabic", document.getElementById("toggleArabic").checked);
  localStorage.setItem("showWordByWord", document.getElementById("toggleWordByWord").checked);
  localStorage.setItem("showSimple", document.getElementById("toggleSimple").checked);
  localStorage.setItem("showTafseer", document.getElementById("toggleTafseer").checked);
  refreshPopupContent();
}
// load saved preferences
document.addEventListener("DOMContentLoaded", ()=>{
  ["Arabic","WordByWord","Simple","Tafseer"].forEach(type=>{
    const key="show"+type;
    if(localStorage.getItem(key)!==null){
      document.getElementById("toggle"+type).checked = localStorage.getItem(key)==="true";
    }
  });
});
function refreshPopupContent(){
  const popup=document.getElementById("popup");
  if(!popup || popup.style.display==="none") return;
  if(!currentVerseRef) return;
  const idx=getVerseIndex(currentVerseRef);
  if(idx<0) return;
    loadInitialChunk(idx,popupPhraseCache);
    const verses=document.querySelectorAll(".verseText");
    verses.forEach(v=>v.style.fontSize=popupFontSize+"rem");
  }

</script>
<script>
const searchBox = document.getElementById("searchBox");
const suggestionList = document.getElementById("suggestionList");
const resultList = document.getElementById("resultList");
const countDiv = document.getElementById("count");
const listsContainer = document.getElementById("listsContainer");

let timeout, selectedWords = [], referenceSets = [], currentVerseRef = null, firstWordSelected = false;

function normalizeInput(text) {
  return text.replace(/ک/g, "ك").replace(/ی/g, "ي").replace(/ھ/g, "ه").replace(/ہ/g, "ه").replace(/ۃ/g, "ة");
}
function stripHarakaat(text) { return text.replace(/[\u064B-\u0652\u0670\u06D6-\u06ED]/g, ""); }
function sortSuggestionsByLength(words) {
  return words.sort((a,b)=>stripHarakaat(normalizeInput(a)).length - stripHarakaat(normalizeInput(b)).length);
}

const verseIndexMap = {};
versesData.forEach(([ref], idx) => verseIndexMap[ref] = idx);
function getVerseIndex(ref) { return verseIndexMap.hasOwnProperty(ref)?verseIndexMap[ref]:versesData.findIndex(([r])=>r===ref); }

searchBox.addEventListener('input', function() {
  const cursorPos = searchBox.selectionStart;
  searchBox.value = normalizeInput(searchBox.value);
  searchBox.setSelectionRange(cursorPos, cursorPos);

  const trimmed = searchBox.value.trim();
  if(trimmed==="") {
    selectedWords=[]; referenceSets=[]; resultList.innerHTML=""; suggestionList.innerHTML=""; countDiv.textContent="";
    listsContainer.classList.remove("full-suggestions"); firstWordSelected=false; return;
  }
  debounceSearch();
});

function debounceSearch() {
  clearTimeout(timeout);
  timeout = setTimeout(()=>{
    const raw = searchBox.value;
    const input = raw.trimEnd();

    if(selectedWords.length>0){
      listsContainer.classList.remove("full-suggestions");
      if(raw.endsWith(" ")) { showNextWordSuggestions(); }
      else { const currentWord = raw.slice(raw.lastIndexOf(" ")+1); showNextWordSuggestions(); showFilteredNextWordSuggestions(currentWord); }
      return;
    }

    if(input==="") { resultList.innerHTML=""; suggestionList.innerHTML=""; countDiv.textContent=""; listsContainer.classList.remove("full-suggestions"); return; }
    if(input.endsWith(" ")) return;

    let currentWord=input.split(" ").pop(); if(!currentWord) return;
    if(selectedWords.length===0) listsContainer.classList.add("full-suggestions");

    const matchMode=document.querySelector('input[name="matchMode"]:checked').value;
    let matches=indexData.filter(([noHarakaat])=>matchMode==="exact"?noHarakaat.startsWith(currentWord):matchMode==="partial"?noHarakaat.includes(currentWord):noHarakaat.endsWith(currentWord));
    let wordsWithHarakaat=sortSuggestionsByLength(matches.map(([_,withHarakaat])=>withHarakaat));

    suggestionList.innerHTML="";
    wordsWithHarakaat.forEach(word=>{
      const li=document.createElement("li"); li.textContent=word; li.onclick=()=>selectSuggestion(word); suggestionList.appendChild(li);
    });
    suggestionList.scrollTop=0;
  },300);
}

// --- next word suggestion ---
function showNextWordSuggestions() {
  const commonRefs = intersectSets(referenceSets);
  const phraseWithHarakaat = selectedWords.join(" ");
  const nextWordPairs = [];

  commonRefs.forEach(ref=>{
    const verse = getVerseByRef(ref);
    const words = verse.trim().split(/\s+/);
    for(let i=0;i<=words.length-selectedWords.length;i++){
      if(words.slice(i,i+selectedWords.length).join(" ")===phraseWithHarakaat){
        const nextWord = words[i+selectedWords.length]; if(nextWord) nextWordPairs.push([ref,nextWord]);
      }
    }
  });

  nextWordPairs.sort((a,b)=>getVerseIndex(a[0])-getVerseIndex(b[0]));

  const seen=new Set(); const orderedNextWords=[];
  nextWordPairs.forEach(([_,word])=>{ if(!seen.has(word)){ seen.add(word); orderedNextWords.push(word); } });

  suggestionList.innerHTML="";
  orderedNextWords.forEach(word=>{ const li=document.createElement("li"); li.textContent=word; li.onclick=()=>selectSuggestion(word); suggestionList.appendChild(li); });
  suggestionList.scrollTop=0;
}

function showFilteredNextWordSuggestions(prefix){
  const items=[...suggestionList.querySelectorAll("li")];
  const normalizedPrefix=stripHarakaat(normalizeInput(prefix));
  let filtered=items.filter(li=>stripHarakaat(normalizeInput(li.textContent)).startsWith(normalizedPrefix));
  let sortedFiltered=sortSuggestionsByLength(filtered.map(li=>li.textContent));

  suggestionList.innerHTML="";
  sortedFiltered.forEach(word=>{ const li=document.createElement("li"); li.textContent=word; li.onclick=()=>selectSuggestion(word); suggestionList.appendChild(li); });
  suggestionList.scrollTop=0;
}

// --- selection ---
function selectSuggestion(wordWithHarakaat){
  listsContainer.classList.remove("full-suggestions");
  const words=searchBox.value.trim().split(" ");
  if(searchBox.value.endsWith(" ")||words.length===0) words.push(wordWithHarakaat); else words[words.length-1]=wordWithHarakaat;
  searchBox.value=words.join(" ")+" "; suggestionList.innerHTML="";

  const [entry] = indexData.filter(([_,h])=>h===wordWithHarakaat);
  if(entry) referenceSets.push(new Set(entry[2].split("@")));
  selectedWords.push(wordWithHarakaat);
  if(selectedWords.length===1) firstWordSelected=true;

  const commonRefs=intersectSets(referenceSets);
  const phrase=selectedWords.join(" ");
  const matched=commonRefs.filter(ref=>getVerseByRef(ref).includes(phrase));
  showReferences(matched,phrase); showNextWordSuggestions();
}

// --- display ---
function showReferences(refs, phrase=""){
  resultList.innerHTML="";
  const sortedRefs=refs.slice().sort((a,b)=>getVerseIndex(a)-getVerseIndex(b));
  const verseCount=sortedRefs.length;
  let occurrenceCount=0;
  if(phrase){
    const regex=new RegExp("(^|\\s)"+phrase.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"(?=\\s|$)","g");
    sortedRefs.forEach(ref=>{ const verse=getVerseByRef(ref); const matches=verse.match(regex); if(matches) occurrenceCount+=matches.length; });
  }
  countDiv.textContent=`عدد النتائج: ${verseCount} آية – عدد التكرار: ${occurrenceCount} مرة`;

  sortedRefs.forEach(ref=>{
    const verse=getVerseByRef(ref);
    let perVerseCount=0;
    if(phrase){ const regex=new RegExp("(^|\\s)"+phrase.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"(?=\\s|$)","g"); const matches=verse.match(regex); if(matches) perVerseCount=matches.length; }

    const li=document.createElement("li");
    const refDiv=document.createElement("div"); refDiv.textContent=formatReference(ref);
    const countDivPerVerse=document.createElement("div"); countDivPerVerse.textContent=`تكرار في هذه الآية: ${perVerseCount}`;
    countDivPerVerse.style.fontSize="0.8em"; countDivPerVerse.style.color="#555"; countDivPerVerse.style.marginRight="1rem";

    li.appendChild(refDiv); li.appendChild(countDivPerVerse);
    li.onclick=()=>showVersePopup(ref,phrase);
    resultList.appendChild(li);
  });
  resultList.scrollTop=0;
}

function formatReference(ref){ const [s,a,p,r]=ref.split(":"); return `سورة ${s}، آية ${a}، جزء ${p}، ركوع ${r}`; }
function getVerseByRef(ref){ const verse=versesData.find(([r])=>r===ref); return verse?verse[1]:""; }
function highlight(verse,phrase){ const escaped=phrase.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); const regex=new RegExp("(^|\\s)"+escaped+"(?=\\s|$)","g"); return verse.replace(regex,m=>m.replace(escaped,`<mark>${phrase}</mark>`)); }

let CHUNK = 20; 
let loadedStart = null, loadedEnd = null; 
let popupPhraseCache = ""; 

function appendBlockAt(container, idx, phrase) {
  const [r, verse] = versesData[idx];
  if (container.querySelector(`[data-ref="${r}"]`)) return;

  const block = document.createElement("div");
  block.className = "verseBlock";
  block.setAttribute("data-ref", r);

  const refDiv = document.createElement("div");
  refDiv.className = "verseRef";
  refDiv.textContent = formatReference(r);
  block.appendChild(refDiv);

  // Arabic
  if (document.getElementById("toggleArabic")?.checked) {
    const textDiv = document.createElement("div");
    textDiv.className = "verseText";
    textDiv.innerHTML = (phrase && verse.includes(phrase)) ? highlight(verse, phrase) : verse;
    textDiv.style.fontSize = popupFontSize + "rem";
    block.appendChild(textDiv);
  }

  // Word by Word
  if (document.getElementById("toggleWordByWord")?.checked && window.wordByWordData) {
    const wEntry = wordByWordData.find(([ref]) => ref === r);
    if (wEntry) {
      const w = document.createElement("div");
      w.className = "verseText";
      w.style.color = "green";
      w.textContent = wEntry[1];
      w.style.fontSize = popupFontSize + "rem";
      block.appendChild(w);
    }
  }

  // Simple Translation
  if (document.getElementById("toggleSimple")?.checked && window.simpleTranslationData) {
    const sEntry = simpleTranslationData.find(([ref]) => ref === r);
    if (sEntry) {
      const s = document.createElement("div");
      s.className = "verseText";
      s.style.color = "blue";
      s.textContent = sEntry[1];
      s.style.fontSize = popupFontSize + "rem";
      block.appendChild(s);
    }
  }

  // Tafseer
  if (document.getElementById("toggleTafseer")?.checked && window.tafseerData) {
    const tEntry = tafseerData.find(([ref]) => ref === r);
    if (tEntry) {
      const t = document.createElement("div");
      t.className = "verseText";
      t.style.color = "brown";
      t.textContent = tEntry[1];
      t.style.fontSize = popupFontSize + "rem";
      block.appendChild(t);
    }
  }

  container.appendChild(block);
}

function prependBlockAt(container, idx, phrase) {
  const [r, verse] = versesData[idx];
  if (container.querySelector(`[data-ref="${r}"]`)) return;

  const block = document.createElement("div");
  block.className = "verseBlock";
  block.setAttribute("data-ref", r);

  const refDiv = document.createElement("div");
  refDiv.className = "verseRef";
  refDiv.textContent = formatReference(r);
  block.appendChild(refDiv);

  // Arabic
  if (document.getElementById("toggleArabic")?.checked) {
    const textDiv = document.createElement("div");
    textDiv.className = "verseText";
    textDiv.innerHTML = (phrase && verse.includes(phrase)) ? highlight(verse, phrase) : verse;
    textDiv.style.fontSize = popupFontSize + "rem";
    block.appendChild(textDiv);
  }

  // Word by Word
  if (document.getElementById("toggleWordByWord")?.checked && window.wordByWordData) {
    const wEntry = wordByWordData.find(([ref]) => ref === r);
    if (wEntry) {
      const w = document.createElement("div");
      w.className = "verseText";
      w.style.color = "green";
      w.textContent = wEntry[1];
      w.style.fontSize = popupFontSize + "rem";
      block.appendChild(w);
    }
  }

  // Simple Translation
  if (document.getElementById("toggleSimple")?.checked && window.simpleTranslationData) {
    const sEntry = simpleTranslationData.find(([ref]) => ref === r);
    if (sEntry) {
      const s = document.createElement("div");
      s.className = "verseText";
      s.style.color = "blue";
      s.textContent = sEntry[1];
      s.style.fontSize = popupFontSize + "rem";
      block.appendChild(s);
    }
  }

  // Tafseer
  if (document.getElementById("toggleTafseer")?.checked && window.tafseerData) {
    const tEntry = tafseerData.find(([ref]) => ref === r);
    if (tEntry) {
      const t = document.createElement("div");
      t.className = "verseText";
      t.style.color = "brown";
      t.textContent = tEntry[1];
      t.style.fontSize = popupFontSize + "rem";
      block.appendChild(t);
    }
  }

  container.insertBefore(block, container.firstChild);
}

function loadInitialChunk(centerIdx, phrase) {
  const container = document.getElementById("popupContent");
  container.innerHTML = "";
  const half = Math.floor(CHUNK / 2);
  let start = Math.max(0, centerIdx - half);
  if (start + CHUNK > versesData.length) start = Math.max(0, versesData.length - CHUNK);
  let end = Math.min(versesData.length - 1, start + CHUNK - 1);
  for (let i = start; i <= end; i++) appendBlockAt(container, i, phrase);
  loadedStart = start;
  loadedEnd = end;
}

function showVersePopup(ref, phrase = "") {
  const popup = document.getElementById("popup");
  const container = document.getElementById("popupContent");
  popupPhraseCache = phrase || "";
  const idx = getVerseIndex(ref);
  if (idx < 0) return;
  loadInitialChunk(idx, popupPhraseCache);
  const verses = container.querySelectorAll(".verseText");
  verses.forEach(v => v.style.fontSize = popupFontSize + "rem");
  popup.style.display = "block";
  currentVerseRef = ref;

  setTimeout(() => {
    const sel = container.querySelector(`[data-ref="${ref}"]`);
    if (sel) sel.scrollIntoView({ behavior: "instant", block: "center" });
    const centered = getCenteredBlock();
    if (centered) currentVerseRef = centered.getAttribute("data-ref");
  }, 30);

  if (!container._infiniteAttached) {
    container._infiniteAttached = true;
    container.addEventListener('scroll', function() {
      if (container.scrollTop < 120 && loadedStart > 0) {
        const oldScrollHeight = container.scrollHeight;
        const newStart = Math.max(0, loadedStart - CHUNK);
        for (let i = newStart; i < loadedStart; i++) prependBlockAt(container, i, popupPhraseCache);
        loadedStart = newStart;
        container.scrollTop += (container.scrollHeight - oldScrollHeight);
      }
      if (container.scrollHeight - container.scrollTop - container.clientHeight < 120 && loadedEnd < versesData.length - 1) {
        const newEnd = Math.min(versesData.length - 1, loadedEnd + CHUNK);
        for (let i = loadedEnd + 1; i <= newEnd; i++) appendBlockAt(container, i, popupPhraseCache);
        loadedEnd = newEnd;
      }
      const centered = getCenteredBlock();
      if (centered) currentVerseRef = centered.getAttribute("data-ref");
    }, { passive: true });
  }
}

function closePopup() { document.getElementById("popup").style.display = "none"; }

function copyVisibleVerses() {
  const container = document.getElementById("popupContent");
  const cRect = container.getBoundingClientRect();
  const blocks = [...container.querySelectorAll(".verseBlock")];
  const parts = [];
  blocks.forEach(block => {
    const rect = block.getBoundingClientRect();
    const visTop = Math.max(rect.top, cRect.top);
    const visBottom = Math.min(rect.bottom, cRect.bottom);
    if (visBottom - visTop > 0.5) {
      const texts = block.querySelectorAll(".verseText");
      let combinedText = "";
      texts.forEach(t => combinedText += t.innerText.trim() + "\n");
      const ref = block.getAttribute("data-ref");
      parts.push(`${formatReference(ref)}\n${combinedText.trim()}`);
    }
  });
  if (parts.length > 0) navigator.clipboard.writeText(parts.join("\n\n")).then(() => alert("تم نسخ النصوص الظاهرة"));
}

function getCenteredBlock() {
  const container = document.getElementById("popupContent");
  if (!container) return null;
  const cRect = container.getBoundingClientRect();
  const centerY = cRect.top + cRect.height / 2;
  let best = null, bestDiff = Infinity;
  container.querySelectorAll(".verseBlock").forEach(b => {
    const r = b.getBoundingClientRect();
    const mid = r.top + r.height / 2;
    const diff = Math.abs(mid - centerY);
    if (diff < bestDiff) { bestDiff = diff; best = b; }
  });
  return best;
}

window.addEventListener("click", e => {
  const popup = document.getElementById("popup");
  if (popup && window.getComputedStyle(popup).display !== "none" && !popup.contains(e.target) && e.target.tagName !== "LI" && e.target.parentElement?.tagName !== "LI") closePopup();
});

searchBox.addEventListener('keydown', function(e) {
  if (e.key === 'Backspace') {
    e.preventDefault();
    let val = searchBox.value;
    if (!val.trim()) {
      searchBox.value = ""; selectedWords = []; referenceSets = [];
      resultList.innerHTML = ""; suggestionList.innerHTML = ""; countDiv.textContent = "";
      listsContainer.classList.remove("full-suggestions"); debounceSearch(); firstWordSelected = false; return;
    }
    val = val.trimEnd(); const lastSpace = val.lastIndexOf(" ");
    searchBox.value = (lastSpace >= 0) ? val.substring(0,lastSpace+1) : "";
    selectedWords = searchBox.value.trim().split(" ").filter(w => w.length>0).map(normalizeInput);
    referenceSets = [];
    selectedWords.forEach(word => { const [entry] = indexData.filter(([_, h]) => h === word); if (entry) referenceSets.push(new Set(entry[2].split("@"))); });
    if (selectedWords.length === 0) {
      resultList.innerHTML = ""; suggestionList.innerHTML = ""; countDiv.textContent = "";
      listsContainer.classList.remove("full-suggestions"); debounceSearch(); firstWordSelected = false;
    } else {
      const commonRefs = intersectSets(referenceSets);
      const phrase = selectedWords.join(" ");
      const matched = commonRefs.filter(ref => getVerseByRef(ref).includes(phrase));
      showReferences(matched, phrase); showNextWordSuggestions();
    }
  }
});

function intersectSets(sets) { if (sets.length===0) return []; return [...sets.reduce((a,b)=>new Set([...a].filter(x=>b.has(x))))]; }

let popupFontSize = parseFloat(localStorage.getItem('popupFontSize')) || 1.6;
function adjustFontSize(delta) {
  popupFontSize += delta * 0.1; 
  if (popupFontSize < 1) popupFontSize = 1;   
  if (popupFontSize > 3) popupFontSize = 3;
  localStorage.setItem('popupFontSize', popupFontSize);
  const verses = document.querySelectorAll("#popupContent .verseText");
  verses.forEach(v => v.style.fontSize = popupFontSize + "rem");
}

(function(){
  const STEP_PCT = 0.5;
  function getContainer() { return document.getElementById('popupContent'); }
  function isPopupVisible() {
    const popup = document.getElementById('popup');
    return popup && window.getComputedStyle(popup).display !== 'none';
  }
  function clampTop(t) {
    const c = getContainer();
    return Math.max(0, Math.min(c.scrollHeight - c.clientHeight, t));
  }
  function scrollByPercent(direction) {
    const c = getContainer();
    if (!c) return;
    const step = Math.round(c.clientHeight * STEP_PCT);
    const newTop = clampTop(c.scrollTop + direction * step);
    c.scrollTo({ top: newTop, behavior: 'smooth' });
  }
  document.addEventListener('keydown', (e) => {
    if (!isPopupVisible()) return;
    if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
    if (e.key === 'ArrowDown' || e.key === 'PageDown') { e.preventDefault(); scrollByPercent(1); }
    if (e.key === 'ArrowUp' || e.key === 'PageUp') { e.preventDefault(); scrollByPercent(-1); }
  }, true);
})();
</script>
</body>
</html>